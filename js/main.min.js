"use strict";!function(){function e(){var e=document.querySelectorAll(".btn");u?(document.body.classList.add("in-process"),e.forEach(function(e){e.classList.contains("init-load-btn")?e.disabled=!0:e.disabled=!1})):(document.body.classList.remove("in-process"),e.forEach(function(e){e.classList.contains("in-process-btn")?e.disabled=!0:e.disabled=!1})),parseInt(localStorage.currentLimit,10)<0?p.classList.add("negative-balance"):p.classList.remove("negative-balance")}function t(e,t){if(a(),s.classList.contains("pop-up-visible")){s.classList.remove("pop-up-visible");var o=s.children;if(o.length)for(var r=0;r<o.length;r++)o[r].classList.contains("pop-up")&&s.removeChild(o[r])}else n(e,t),s.classList.add("pop-up-visible");i.cycleEnded&&i.endCycle()}function n(e,t){var n=document.createElement("div");n.classList.add("pop-up"),n.id=e,"setlimit-pop-up"===e&&(n.innerHTML='<div class="pop-up__wrapper">\n        <p class="pop-up__p">Set your day limit<br> 1 - 29999</p>\n        <div class="pop-up__field-wrapper">\n          <input type="number" class="pop-up__field" id="setlimit-field" min="1" max="29999" step="1" autofocus>\n        </div>\n        <p class="pop-up__p">Set a period<br> 1 - 7 (days)</p>\n        <div class="pop-up__field-wrapper custom-range">\n          <input type="range" id="deadline-range" min="1" max="7" step="1" value="1">\n        </div>\n        <div class="pop-up__field-wrapper">\n          <input type="text" class="pop-up__field" id="deadline-range-output" value="1" readonly>\n        </div>\n        <div class="pop-up__controls">\n          <button type="button" class="btn" id="setlimit-submit" data-pop-id="setlimit-pop-up" data-submit="ok">Ok</button>\n          <button type="button" class="btn" id="setlimit-cancel" data-pop-id="setlimit-pop-up" data-submit="cancel">Cancel</button>\n        </div>\n      </div>'),"rest-confirm-pop-up"===e&&(n.innerHTML='<div class="pop-up__wrapper">\n        <p class="pop-up__p">Your progress will be lost. Continue?</p><br>\n        <div class="pop-up__controls">\n          <button type="button" class="btn" id="reset-confirm" data-pop-id="rest-confirm-pop-up" data-submit="ok">Ok</button>\n          <button type="button" class="btn" id="reset-cancel" data-pop-id="rest-confirm-pop-up" data-submit="cancel">Cancel</button>\n        </div>\n      </div>'),"setexpense-pop-up"===e&&(n.innerHTML='<div class="pop-up__wrapper">\n        <p class="pop-up__p">Amount spent</p>\n        <div class="pop-up__field-wrapper">\n          <input type="number" class="pop-up__field" id="setexpense-value-field" min="1" max="29999" step="1" value="" autofocus>\n        </div>\n        <p class="pop-up__p">Purchase description</p>\n        <div class="pop-up__field-wrapper">\n          <input type="text" class="pop-up__field" maxlength="30" id="setexpense-name-field" value="">\n        </div>\n        <div class="pop-up__controls">\n          <button type="button" class="btn" id="setexpense-submit" data-submit="ok">Ok</button>\n          <button type="button" class="btn" id="setexpense-cancel" data-pop-id="setexpense-pop-up" data-submit="ok">Cancel</button>\n        </div>\n      </div>'),s.appendChild(n),t&&t()}function a(){document.querySelectorAll(".pop-up__field").forEach(function(e){e.value=""})}function i(){window.addEventListener("click",function(e){var n=e.target.id,a=e.target.classList.contains("btn"),s=e.target.dataset.popId;a&&("final-reset"===n||"reset-confirm"===n?(this.resetAll(),t(s)):"setlimit-submit"===n?(this.setLimit(),t(s)):"setexpense-submit"===n?(this.limitSubtract(),i.cycleEnded||t(s)):"set-limit-btn"===n?t(s,function(){var e=document.querySelector("#deadline-range"),t=document.querySelector("#deadline-range-output");e.addEventListener("input",function(){t.value=e.value})}):t(s))}.bind(this)),this.init()}var s=document.querySelector("#main"),o=document.querySelector("#adviser-content-wrapper"),r=document.querySelector("#countdown"),p=document.querySelector("#limit-field"),l={expenseErrorTxt:"Invalid value. Valid purchase amount is from 1 to 29999, purchase description field can't be empty ",limitErrorTxt:"Invalid value. Valid limit: 1 to 29999. Valid period: 1 - 7 days ",messageType:{error:"error-message-open",regular:"regular-message-open"}},c=86400,d=0,u=u||!1,m=m||!1,v=localStorage.initialLimit||"",y=localStorage.currentLimit||"",f=localStorage.startDeadLine||"",g=localStorage.deadLinePeriod||"",b=localStorage.endDeadLine||"",S=localStorage.expenseItems||[],L=L||"",h=h||"";i.prototype.setLimit=function(){var t=document.querySelector("#setlimit-field"),n=document.querySelector("#deadline-range");return this.cleanAdviser(),v=parseInt(t.value,10),(g=parseInt(n.value,10))<1||g>7||v<=0||isNaN(v)||v>29999?(this.showSystemMessage(l.limitErrorTxt,l.messageType.error,1e4),!1):(p.value=v,localStorage.setItem("initialLimit",v),localStorage.setItem("secInPassedDays",c),this.setInitialTimer(),setTimeout(function(){this.countdownWork(),r.style.display="block"}.bind(this),1e3),e(),y=v,localStorage.setItem("currentLimit",y),v)},i.prototype.setInitialTimer=function(){f=new Date,b=new Date,b.setDate(f.getDate()+g),localStorage.setItem("startDeadLine",f),localStorage.setItem("endDeadLine",b),localStorage.setItem("deadLinePeriod",g),u=!0},i.prototype.countdownWork=function(){if(u){var e=new Date;if((e=Math.floor((b-e)/1e3))<=0){for(;parseInt(localStorage.secInPassedDays,10)<86400*g&&parseInt(localStorage.currentLimit,10)+parseInt(localStorage.initialLimit,10)<parseInt(localStorage.initialLimit,10)*g;)this.renewLimit(parseInt(localStorage.initialLimit,10)),localStorage.setItem("secInPassedDays",c);return u=!1,m=!0,r.style.display="",this.endCycle(),!1}86400*g-e>parseInt(localStorage.secInPassedDays,10)&&e>0&&(this.renewLimit(parseInt(localStorage.initialLimit,10)),c=parseInt(localStorage.secInPassedDays,10),c+=86400,localStorage.setItem("secInPassedDays",c));var t=e%60;e=Math.floor(e/60),t<10&&(t="0"+t);var n=e%60;e=Math.floor(e/60),n<10&&(n="0"+n);var a=e%(24*g);e=Math.floor(e/24),a<10&&(a="0"+a),r.innerHTML=a+":"+n+":"+t,setTimeout(function(){this.countdownWork()}.bind(this),1e3)}else r.innerHTML="";return!0},i.prototype.limitSubtract=function(){var t=document.querySelector("#setexpense-value-field"),n=document.querySelector("#setexpense-name-field");if(d=parseInt(t.value,10),Number.isInteger(d)&&d>0&&d<3e4&&n.value){y=localStorage.currentLimit||v,y-=d,localStorage.setItem("currentLimit",y),p.value=y;var a={name:n.value,price:d};return this.addExpenseItem(a),e(),y<-3e4?(u=!1,m=!0,"Limit is exceeded"):y}return this.showSystemMessage(l.expenseErrorTxt,l.messageType.error,1e4),!1},i.prototype.addExpenseItem=function(e){localStorage.expenseItems&&(S=JSON.parse(localStorage.expenseItems));var t={name:e.name,price:e.price};S.length>=3&&S.pop(),S.unshift(t),localStorage.setItem("expenseItems",JSON.stringify(S)),this.showExpenseList()},i.prototype.showExpenseList=function(){this.cleanAdviser();var e=!0;if(localStorage.expenseItems&&(S=JSON.parse(localStorage.expenseItems),e=!1),!e){var t=document.createElement("ul");t.classList.add("expense-list"),o.appendChild(t),t.innerHTML=S.map(function(e){return'<li class="expense-list__item">'+e.name+'<span class="expense-list__cash">'+e.price+"</span></li>"}).join("");document.querySelectorAll(".expense-list__item").forEach(function(e){e.style.paddingRight=e.children[0].offsetWidth+24+"px"})}},i.prototype.init=function(){if(localStorage.length){f=new Date(Date.parse(localStorage.startDeadLine)),b=new Date(Date.parse(localStorage.endDeadLine)),g=localStorage.deadLinePeriod,c=localStorage.secInPassedDays,u=!0,this.countdownWork(),this.showExpenseList(),p.value=y,clearTimeout(t);var t=setTimeout(function(){r.style.display="block"},1e3)}localStorage.currentLimit&&localStorage.currentLimit<-3e4&&(u=!1,m=!0,this.endCycle()),e()},i.prototype.renewLimit=function(t){y=parseInt(localStorage.currentLimit,10)||parseInt(localStorage.initialLimit,10),y+=t,p.value=y,localStorage.setItem("currentLimit",y),e()},i.prototype.endCycle=function(){a();var e=document.createElement("div");e.classList.add("pop-up"),e.innerHTML='<div class="pop-up__wrapper">\n      <div id="end-verdict"></div>\n      <div id="end-stat"></div>\n      <div class="pop-up__controls">\n        <button type="button" class="btn" id="final-reset" data-pop-id="end-pop-up" data-submit="ok">Ok</button>\n      </div>\n    </div>',s.appendChild(e),s.classList.add("pop-up-visible"),this.loadStat()},i.prototype.resetAll=function(){u=!1,m=!1,this.cleanAdviser(),v="",y="",f="",b="",g="",S=[],p.value="",localStorage.clear(),e(),document.querySelectorAll(".pop-up").forEach(function(e){e.style.display=""}),c=86400},i.prototype.loadStat=function(){var e=document.querySelector("#end-verdict"),t=document.querySelector("#end-stat");v=parseInt(localStorage.initialLimit,10),y=parseInt(localStorage.currentLimit,10),g=parseInt(localStorage.deadLinePeriod,10),p.value=y,e.innerHTML=!y||y>-3e4?"<p>Time is up</p>":"<p>Purchase limit exceeded</p>",t.innerHTML=y&&y!==v*g?y<0?"<p>Day limit: "+v+"</p>\n      <p>Period (days): "+g+"</p>\n      <p>Spent: "+(v*g+Math.abs(y))+"</p>\n      <p>Overspent: "+Math.abs(y)+"</p>\n      <p>Try again.</p>":"<p>Day limit: "+v+"</p>\n      <p>Period (days): "+g+"</p>\n      <p>Spent: "+(v*g-y)+"</p>\n      <p>Saved: "+y+"</p>\n      <p>Try again.</p>":"<p>Day limit: "+v+"</p>\n      <p>Period (days): "+g+"</p> //посчитать количество прошедших (secInPassedDays) если оно не совпадает с изначально заданным\n      <p>Spent: 0</p>\n      <p>Saved: "+v+"</p>\n      <p>Probably you did it wrong or didn&#39;t write down your purchases. Try again.</p>"},i.prototype.cleanAdviser=function(){clearInterval(h),clearTimeout(L),o.innerHTML="",o.className="",o.classList.add("adviser__wrapper")},i.prototype.showSystemMessage=function(e,t){var n=0;this.cleanAdviser(),h=setInterval(function(){o.innerHTML+=e[n],++n===e.length&&(clearInterval(h),o.innerHTML+='<span class="blinking-cursor">&nbsp;</span>',o.classList.add(t))},30),L=setTimeout(function(){this.cleanAdviser(),this.showExpenseList()}.bind(this),8e3)},new i}();